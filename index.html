<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặng Ngọc Hiếu - Chiến Lược Gia Doanh Nghiệp & F&B</title>
    <meta name="description" content="Chuyên gia Đặng Ngọc Hiếu - Tư vấn chiến lược kinh doanh F&B trên App Food, Xây dựng thương hiệu cá nhân và Marketing thực chiến.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase Imports (Required for Auth mostly, but good practice if expanding) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Initialize Firebase (Placeholder config)
        const firebaseConfig = { apiKey: "placeholder", authDomain: "placeholder", projectId: "placeholder" }; 
        // Note: Real Firebase config isn't needed for Gemini API REST calls, 
        // but structured correctly for future expansion.
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            gold: '#C5A059',
                            dark: '#0F172A',
                            navy: '#1E293B',
                            light: '#F8FAFC',
                            accent: '#3B82F6'
                        }
                    },
                    fontFamily: {
                        serif: ['Merriweather', 'serif'],
                        sans: ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .ai-glow {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        .ai-glow:hover {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
        }
        /* Markdown Styles for AI Output */
        .ai-content p { margin-bottom: 0.5rem; }
        .ai-content strong { color: #C5A059; font-weight: 700; }
        .ai-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.5rem; }
        .ai-content li { margin-bottom: 0.25rem; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="font-sans text-slate-800 bg-slate-50 antialiased">

    <!-- Header / Navigation -->
    <header class="fixed w-full z-50 glass-effect shadow-sm transition-all duration-300" id="navbar">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-serif font-bold text-brand-dark flex items-center gap-2">
                <span class="w-8 h-8 bg-brand-dark text-white rounded-full flex items-center justify-center text-sm">H</span>
                ĐẶNG NGỌC HIẾU
            </a>
            
            <nav class="hidden md:flex space-x-8 items-center font-medium text-slate-600">
                <a href="#about" class="hover:text-brand-gold transition-colors">Về Tôi</a>
                <a href="#strategy" class="hover:text-brand-gold transition-colors">Chiến Lược</a>
                <a href="#services" class="hover:text-brand-gold transition-colors">Dịch Vụ</a>
                <a href="#ai-tool" class="px-5 py-2 bg-brand-dark text-white rounded-full hover:bg-brand-gold transition-colors shadow-lg flex items-center gap-2 animate-pulse">
                    <i class="fa-solid fa-sparkles text-yellow-400"></i> Trợ Lý AI
                </a>
            </nav>

            <button class="md:hidden text-2xl text-brand-dark">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="relative pt-32 pb-20 lg:pt-48 lg:pb-32 overflow-hidden bg-brand-dark text-white">
        <!-- Background decorative elements -->
        <div class="absolute top-0 right-0 w-1/2 h-full bg-gradient-to-l from-slate-800 to-transparent opacity-30"></div>
        <div class="absolute -bottom-20 -left-20 w-96 h-96 bg-brand-gold rounded-full filter blur-[120px] opacity-20"></div>

        <div class="container mx-auto px-6 relative z-10">
            <div class="flex flex-col lg:flex-row items-center gap-12">
                <div class="lg:w-1/2 space-y-8">
                    <div class="inline-block px-4 py-1.5 border border-brand-gold/30 rounded-full bg-brand-gold/10 text-brand-gold text-sm font-semibold tracking-wider uppercase">
                        Giải pháp tăng trưởng doanh thu
                    </div>
                    <h1 class="text-4xl lg:text-6xl font-serif font-bold leading-tight">
                        Đột Phá Doanh Thu <br>
                        F&B & <span class="text-brand-gold">Thương Hiệu Cá Nhân</span>
                    </h1>
                    <p class="text-lg text-slate-300 leading-relaxed max-w-xl text-justify">
                        Tôi giúp các chủ quán tối ưu hóa vận hành trên App Food, xây dựng chiến lược Marketing thực chiến và định vị Thương hiệu cá nhân để dẫn đầu thị trường.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 pt-4">
                        <a href="#ai-tool" class="px-8 py-4 bg-brand-gold text-brand-dark font-bold rounded hover:bg-white hover:scale-105 transition-all duration-300 text-center shadow-[0_0_20px_rgba(197,160,89,0.4)] flex items-center justify-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Thử Nghiệm AI
                        </a>
                        <a href="#services" class="px-8 py-4 border border-slate-500 text-white font-medium rounded hover:border-white hover:bg-white/5 transition-all text-center">
                            Dịch Vụ Của Tôi
                        </a>
                    </div>
                    
                    <div class="flex gap-8 pt-8 border-t border-slate-700">
                        <div>
                            <span class="block text-3xl font-bold text-brand-gold">500+</span>
                            <span class="text-sm text-slate-400">Quán F&B Tăng Trưởng</span>
                        </div>
                        <div>
                            <span class="block text-3xl font-bold text-brand-gold">Gemini</span>
                            <span class="text-sm text-slate-400">AI Power Core</span>
                        </div>
                    </div>
                </div>
                
                <div class="lg:w-1/2 relative">
                    <div class="relative z-10 rounded-2xl overflow-hidden shadow-2xl border border-slate-700 ai-glow bg-slate-800">
                        <div class="bg-gradient-to-br from-slate-700 to-slate-900 aspect-[4/5] sm:aspect-[4/3] lg:aspect-[4/5] flex flex-col justify-end p-8 relative">
                           <svg class="absolute top-0 right-0 w-full h-full opacity-10" viewBox="0 0 100 100">
                                <circle cx="80" cy="20" r="15" stroke="white" fill="none" />
                                <path d="M80 20 L50 50 L20 40" stroke="white" fill="none" />
                                <circle cx="50" cy="50" r="5" fill="white" />
                           </svg>
                           
                           <div class="relative z-20">
                               <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-xl mb-4 flex items-center justify-center border border-white/20">
                                   <i class="fa-solid fa-store text-2xl text-brand-gold"></i>
                               </div>
                               <h3 class="text-xl font-bold mb-2">Bùng Nổ Doanh Số Online</h3>
                               <p class="text-sm text-slate-300">Tối ưu hóa hiển thị và tỷ lệ chuyển đổi trên các nền tảng GrabFood, ShopeeFood, GoFood với sự hỗ trợ của AI.</p>
                           </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="py-20 bg-white">
        <div class="container mx-auto px-6">
            <div class="flex flex-col md:flex-row gap-16 items-center">
                <div class="md:w-1/2 relative">
                    <div class="w-full aspect-square bg-slate-200 rounded-lg relative overflow-hidden shadow-2xl">
                         <div class="absolute inset-0 bg-slate-300 flex items-center justify-center text-slate-500">
                            
                         </div>
                         <div class="absolute bottom-6 right-6 bg-brand-dark text-white p-6 rounded shadow-xl max-w-xs">
                             <p class="font-serif italic text-lg">"Trong kinh doanh F&B, ai hiểu dữ liệu và khách hàng hơn, người đó thắng."</p>
                         </div>
                    </div>
                </div>
                <div class="md:w-1/2">
                    <h4 class="text-brand-gold font-bold uppercase tracking-widest mb-2">Về Tôi</h4>
                    <h2 class="text-4xl font-serif font-bold text-brand-dark mb-6">Đặng Ngọc Hiếu</h2>
                    <h3 class="text-xl text-slate-600 mb-6 font-medium">Chiến Lược Gia Doanh Nghiệp & Chuyên Gia F&B</h3>
                    
                    <div class="space-y-4 text-slate-600 text-justify leading-relaxed">
                        <p>
                            Với kinh nghiệm thực chiến tư vấn cho hàng trăm thương hiệu F&B, tôi hiểu rõ "nỗi đau" của các chủ quán trong cuộc chiến giành thị phần.
                        </p>
                        <p>
                            Tôi tích hợp **Gemini AI** vào quy trình tư vấn để mang lại tốc độ và sự chính xác. Từ việc phân tích menu, tối ưu từ khóa SEO cho App Food, đến việc viết hàng trăm mẫu quảng cáo chỉ trong vài giây.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Feature Section (Gemini Integration) -->
    <section id="ai-tool" class="py-20 bg-brand-navy text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
        
        <div class="container mx-auto px-6 relative z-10">
            <div class="text-center mb-8">
                <span class="text-brand-gold font-bold uppercase tracking-wider text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bolt text-yellow-400"></i> Powered by Gemini AI
                </span>
                <h2 class="text-3xl md:text-5xl font-serif font-bold mt-2 mb-4">Trợ Lý Chiến Lược Thông Minh</h2>
                <p class="text-slate-300 max-w-2xl mx-auto">
                    Trải nghiệm sức mạnh của Generative AI. Chọn một công cụ bên dưới để bắt đầu tối ưu doanh nghiệp của bạn.
                </p>
            </div>

            <!-- AI Interface -->
            <div class="max-w-5xl mx-auto bg-slate-800 rounded-xl shadow-2xl border border-slate-600 overflow-hidden flex flex-col md:flex-row h-[600px]">
                <!-- Sidebar Tools -->
                <div class="w-full md:w-64 bg-slate-900 p-4 border-r border-slate-700 flex flex-col shrink-0">
                    <div class="text-brand-gold font-bold mb-6 flex items-center gap-2 px-2">
                        <i class="fa-solid fa-brain"></i> AI Toolbox
                    </div>
                    <div class="space-y-3">
                        <button onclick="setMode('chat')" id="btn-chat" class="w-full text-left px-4 py-3 bg-slate-800 rounded-lg text-sm text-white hover:bg-slate-700 transition flex items-center gap-3 border border-brand-gold/50 shadow-lg">
                            <i class="fa-regular fa-comments text-brand-gold"></i> Tư Vấn Chung
                        </button>
                        <button onclick="setMode('menu')" id="btn-menu" class="w-full text-left px-4 py-3 rounded-lg text-sm text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 hover:text-white">
                            <i class="fa-solid fa-utensils text-green-400"></i> ✨ Tối Ưu Menu SEO
                        </button>
                        <button onclick="setMode('content')" id="btn-content" class="w-full text-left px-4 py-3 rounded-lg text-sm text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 hover:text-white">
                            <i class="fa-solid fa-pen-nib text-purple-400"></i> ✨ Viết Content
                        </button>
                    </div>
                    
                    <div class="mt-auto p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400 mb-2">Trạng thái API:</p>
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-xs text-slate-300 font-mono">Gemini-2.5-Flash Online</span>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="flex-1 flex flex-col bg-slate-800 relative">
                    <!-- Header of Chat -->
                    <div class="h-14 border-b border-slate-700 flex items-center px-6 justify-between bg-slate-800/80 backdrop-blur">
                        <span id="mode-title" class="font-bold text-white flex items-center gap-2">
                            Tư Vấn Chiến Lược
                        </span>
                        <button onclick="clearChat()" class="text-xs text-slate-400 hover:text-white flex items-center gap-1">
                            <i class="fa-solid fa-trash"></i> Xóa lịch sử
                        </button>
                    </div>

                    <!-- Chat History -->
                    <div class="flex-1 p-6 overflow-y-auto space-y-6" id="chat-container">
                        <!-- Welcome Message -->
                        <div class="flex gap-4">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brand-gold to-yellow-600 flex items-center justify-center flex-shrink-0 shadow-lg border border-white/10">
                                <i class="fa-solid fa-robot text-white text-sm"></i>
                            </div>
                            <div class="bg-slate-700/80 p-4 rounded-2xl rounded-tl-none text-slate-200 shadow-md max-w-[90%] backdrop-blur-sm border border-slate-600 ai-content">
                                <p>Chào bạn, tôi là trợ lý ảo được tích hợp <strong>Gemini AI</strong>.</p>
                                <p class="mt-2 text-sm text-slate-300">Hãy chọn một công cụ bên trái:</p>
                                <ul class="mt-2 text-sm text-slate-300 space-y-1">
                                    <li><strong class="text-brand-gold">Tối Ưu Menu SEO:</strong> Biến tên món ăn thường thành tên "hút khách" trên ShopeeFood/Grab.</li>
                                    <li><strong class="text-purple-400">Viết Content:</strong> Tạo bài viết quảng cáo Facebook/TikTok chỉ từ vài từ khóa.</li>
                                    <li><strong class="text-blue-400">Tư Vấn Chung:</strong> Hỏi đáp mọi thứ về kinh doanh F&B.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="p-4 bg-slate-900 border-t border-slate-700 z-20">
                        <form id="ai-chat-form" class="flex gap-2 relative" onsubmit="handleChat(event)">
                            <div class="relative flex-1">
                                <input type="text" id="user-input" 
                                    class="w-full bg-slate-800 border border-slate-600 rounded-lg pl-4 pr-12 py-3 text-white focus:outline-none focus:border-brand-gold focus:ring-1 focus:ring-brand-gold transition shadow-inner placeholder-slate-500" 
                                    placeholder="Nhập câu hỏi của bạn...">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 hidden md:block">
                                    Enter để gửi
                                </div>
                            </div>
                            <button type="submit" id="send-btn" class="bg-gradient-to-r from-brand-gold to-yellow-600 text-white px-6 py-2 rounded-lg font-bold hover:shadow-[0_0_15px_rgba(197,160,89,0.5)] transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="py-20 bg-slate-50">
        <div class="container mx-auto px-6">
            <div class="text-center mb-16">
                <h2 class="text-3xl md:text-4xl font-serif font-bold text-brand-dark mb-4">Dịch Vụ Chiến Lược</h2>
                <div class="w-20 h-1 bg-brand-gold mx-auto"></div>
            </div>

            <div class="grid md:grid-cols-3 gap-8">
                <!-- Card 1 -->
                <div class="bg-white p-8 rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 border-t-4 border-brand-gold group">
                    <div class="w-14 h-14 bg-brand-light rounded-full flex items-center justify-center mb-6 text-brand-dark group-hover:bg-brand-gold group-hover:text-white transition">
                        <i class="fa-solid fa-utensils text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3 text-brand-dark">Setup App Food Chuẩn SEO</h3>
                    <p class="text-slate-600 text-sm mb-6">Tối ưu menu, hình ảnh và chương trình khuyến mãi để tăng tỷ lệ chuyển đổi trên Grab/ShopeeFood.</p>
                </div>

                <!-- Card 2 -->
                <div class="bg-white p-8 rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 border-t-4 border-brand-navy group md:-translate-y-4">
                    <div class="w-14 h-14 bg-brand-light rounded-full flex items-center justify-center mb-6 text-brand-dark group-hover:bg-brand-navy group-hover:text-white transition">
                        <i class="fa-solid fa-bullhorn text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3 text-brand-dark">Marketing F&B Thực Chiến</h3>
                    <p class="text-slate-600 text-sm mb-6">Chiến lược kéo khách hàng tới quán và giữ chân họ quay lại bằng trải nghiệm wow.</p>
                </div>

                <!-- Card 3 -->
                <div class="bg-white p-8 rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 border-t-4 border-brand-gold group">
                    <div class="w-14 h-14 bg-brand-light rounded-full flex items-center justify-center mb-6 text-brand-dark group-hover:bg-brand-gold group-hover:text-white transition">
                        <i class="fa-solid fa-user-tie text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3 text-brand-dark">Xây Dựng Nhân Hiệu</h3>
                    <p class="text-slate-600 text-sm mb-6">Định vị hình ảnh chủ doanh nghiệp chuyên nghiệp để tạo niềm tin với đối tác và khách hàng.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 border-t border-slate-800">
        <div class="container mx-auto px-6 text-center md:text-left">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div>
                    <h4 class="text-white font-bold text-lg mb-2">ĐẶNG NGỌC HIẾU</h4>
                    <p class="text-sm">Chuyên gia tư vấn chiến lược doanh nghiệp & F&B.</p>
                </div>
                <div class="flex gap-4">
                    <a href="#" class="w-10 h-10 rounded bg-slate-800 flex items-center justify-center hover:bg-brand-gold hover:text-brand-dark transition"><i class="fa-brands fa-facebook-f"></i></a>
                    <a href="#" class="w-10 h-10 rounded bg-slate-800 flex items-center justify-center hover:bg-brand-gold hover:text-brand-dark transition"><i class="fa-brands fa-tiktok"></i></a>
                </div>
            </div>
            <div class="border-t border-slate-800 mt-8 pt-8 text-xs text-center">
                &copy; 2024 Dang Ngoc Hieu. Powered by Gemini AI.
            </div>
        </div>
    </footer>

    <!-- LOGIC XỬ LÝ GEMINI API -->
    <script>
        // --- 1. CONFIGURATION ---
        const apiKey = ""; // API Key will be injected by the environment
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        let currentMode = 'chat'; // 'chat', 'menu', 'content'

        // --- 2. SYSTEM PROMPTS FOR MODES ---
        const prompts = {
            chat: `Bạn là trợ lý ảo cao cấp của chuyên gia Đặng Ngọc Hiếu. 
                   Vai trò: Chuyên gia tư vấn chiến lược F&B, Marketing và App Food (Grab, ShopeeFood).
                   Phong cách: Chuyên nghiệp, thực tế, dùng thuật ngữ chuyên ngành (traffic, conversion, net profit, cost).
                   Nhiệm vụ: Trả lời ngắn gọn, đi thẳng vào vấn đề. Luôn khuyến khích người dùng đăng ký khóa học hoặc dịch vụ tư vấn sâu hơn nếu vấn đề phức tạp.`,
            
            menu: `Bạn là chuyên gia SEO App Food (ShopeeFood/GrabFood).
                   Nhiệm vụ: Người dùng sẽ đưa tên một món ăn đơn giản. Bạn hãy viết lại tên món đó thật hấp dẫn, kích thích vị giác và chuẩn SEO để người dùng dễ tìm thấy.
                   Output format:
                   1. Tên món chuẩn SEO: [Tên mới]
                   2. Mô tả ngắn (2 dòng): [Mô tả hấp dẫn về hương vị, nguyên liệu]
                   3. Gợi ý Topping nên bán kèm: [List topping]
                   Hãy thêm các từ khóa như: "Siêu ngon", "Đậm đà", "Mới nhất", "Bán chạy".`,
            
            content: `Bạn là chuyên gia Copywriter F&B.
                      Nhiệm vụ: Người dùng sẽ đưa chủ đề hoặc tên món. Bạn hãy viết một bài đăng Facebook/TikTok ngắn (dưới 150 từ).
                      Yêu cầu:
                      - Headline giật tít, đánh trúng nỗi đau hoặc sự thèm thuồng.
                      - Body ngắn gọn, dùng icon sinh động.
                      - Call to Action (CTA) mạnh mẽ ở cuối.
                      - Hashtag liên quan.`
        };

        // --- 3. UI FUNCTIONS ---
        function setMode(mode) {
            currentMode = mode;
            
            // Update UI Buttons
            ['chat', 'menu', 'content'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if (m === mode) {
                    btn.className = "w-full text-left px-4 py-3 bg-slate-800 rounded-lg text-sm text-white hover:bg-slate-700 transition flex items-center gap-3 border border-brand-gold/50 shadow-lg";
                } else {
                    btn.className = "w-full text-left px-4 py-3 rounded-lg text-sm text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 hover:text-white";
                }
            });

            // Update Input Placeholder & Title
            const titles = {
                chat: "Tư Vấn Chiến Lược",
                menu: "Tối Ưu Menu Chuẩn SEO",
                content: "Sáng Tạo Content F&B"
            };
            const placeholders = {
                chat: "Hỏi về chiến lược, vận hành quán, marketing...",
                menu: "Nhập tên món ăn (VD: Cơm tấm, Trà sữa...)",
                content: "Nhập chủ đề bài viết (VD: Khai trương, Món mới...)"
            };

            document.getElementById('mode-title').innerText = titles[mode];
            userInput.placeholder = placeholders[mode];
            userInput.focus();
        }

        function clearChat() {
            chatContainer.innerHTML = '';
            // Add welcome back
            appendMessage('ai', 'Đã xóa lịch sử. Bạn cần hỗ trợ gì tiếp theo?');
        }

        function appendMessage(sender, text) {
            const div = document.createElement('div');
            div.className = "flex gap-4 animate-fade-in";
            
            if (sender === 'ai') {
                // Convert simple markdown to HTML (basic bolding and lists)
                let formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-brand-gold">$1</strong>')
                    .replace(/\n/g, '<br>');

                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brand-gold to-yellow-600 flex items-center justify-center flex-shrink-0 shadow-lg border border-white/10">
                        <i class="fa-solid fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-slate-700/80 p-4 rounded-2xl rounded-tl-none text-slate-200 shadow-md max-w-[90%] backdrop-blur-sm border border-slate-600 ai-content leading-relaxed">
                        ${formattedText}
                    </div>
                `;
            } else {
                div.className = "flex gap-4 flex-row-reverse";
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="fa-solid fa-user text-white text-sm"></i>
                    </div>
                    <div class="bg-brand-accent p-4 rounded-2xl rounded-tr-none text-white shadow-md max-w-[85%]">
                        ${text}
                    </div>
                `;
            }
            
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-4";
            div.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brand-gold to-yellow-600 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-slate-700/50 p-4 rounded-2xl rounded-tl-none text-slate-400 shadow-md flex items-center gap-2 border border-slate-600/50">
                    <span class="text-xs mr-2">Gemini đang suy nghĩ...</span>
                    <span class="w-1.5 h-1.5 bg-brand-gold rounded-full animate-bounce"></span>
                    <span class="w-1.5 h-1.5 bg-brand-gold rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                    <span class="w-1.5 h-1.5 bg-brand-gold rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // --- 4. API HANDLING ---
        async function handleChat(e) {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            // UI Updates
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;
            appendMessage('user', text);
            const loadingId = appendLoading();

            try {
                // Construct Prompt
                const systemInstruction = prompts[currentMode];
                const fullPrompt = `${systemInstruction}\n\nUser Input: ${text}`;

                // Call Gemini API
                const response = await callGeminiAPI(fullPrompt);
                
                removeLoading(loadingId);
                appendMessage('ai', response);

            } catch (error) {
                console.error(error);
                removeLoading(loadingId);
                appendMessage('ai', `⚠️ Lỗi kết nối: ${error.message}. Vui lòng thử lại sau.`);
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        async function callGeminiAPI(promptText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: promptText }]
                }]
            };

            // Retry logic (Exponential Backoff)
            let retries = 0;
            const maxRetries = 3;
            
            while (retries <= maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Không nhận được phản hồi từ AI.";

                } catch (err) {
                    retries++;
                    if (retries > maxRetries) throw err;
                    // Wait before retry: 1s, 2s, 4s
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, retries - 1)));
                }
            }
        }

        // Add custom fade-in animation
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fadeIn 0.3s ease-out forwards;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>